<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oyun Fiyat Takip</title>
  <style>
    :root{--bg:#0b1223;--card:#0f1b33;--card2:#0e172d;--b:#1f2d4a;--t:#e5e7eb;--m:#94a3b8;--g:#22c55e;--r:#ef4444;--y:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#0a1020,#0b1223);color:var(--t)}
    .wrap{max-width:1100px;margin:0 auto;padding:26px}
    h1{margin:0 0 6px;font-size:34px;color:#fff}
    .sub{margin:0 0 18px;color:var(--m)}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    select,input{background:#0b1430;border:1px solid var(--b);color:var(--t);padding:10px 12px;border-radius:10px;outline:none}
    input{flex:1;min-width:260px}
    .meta{color:var(--m);margin-left:auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--b);border-radius:14px;padding:14px;min-height:170px}
    .row{display:flex;gap:10px;align-items:flex-start}
    .img{width:92px;height:42px;border-radius:10px;object-fit:cover;border:1px solid var(--b);background:#0b1430}
    .title{font-size:16px;font-weight:700;margin:0 0 8px}
    .muted{color:var(--m);font-size:12px}
    .sec{margin-top:10px;padding-top:10px;border-top:1px solid rgba(148,163,184,.2)}
    .line{display:flex;justify-content:space-between;gap:10px;align-items:center;margin:6px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--b);border-radius:999px;padding:3px 8px;font-size:12px;color:#cbd5e1;background:#0b1430}
    .btn{color:#93c5fd;text-decoration:none}
    .btn:hover{text-decoration:underline}
    .price{font-weight:700}
    .strike{color:var(--m);text-decoration:line-through;font-weight:400;margin-right:8px}
    .tag{font-size:12px;border-radius:999px;padding:3px 8px;border:1px solid var(--b);background:#0b1430}
    .green{border-color:rgba(34,197,94,.6);box-shadow:0 0 0 1px rgba(34,197,94,.15) inset}
    .red{border-color:rgba(239,68,68,.55)}
    .warn{border-color:rgba(245,158,11,.55)}
    .small{font-size:12px;color:var(--m)}
    .topline{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Oyun Fiyat Takip</h1>
    <p class="sub">Steam + Epic — 200 oyun (free yok). En ucuz mağaza yeşil.</p>

    <div class="bar">
      <select id="cc">
        <option value="tr" selected>TR</option>
        <option value="us">US</option>
        <option value="gb">GB</option>
        <option value="de">DE</option>
        <option value="fr">FR</option>
      </select>
      <input id="q" placeholder="Oyun ara (isim yaz)..." />
      <div class="meta" id="meta">Yükleniyor...</div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

<script>
const API = "/api/games?limit=200&cc=";

const elGrid = document.getElementById("grid");
const elMeta = document.getElementById("meta");
const elQ = document.getElementById("q");
const elCC = document.getElementById("cc");

let ALL = [];

function moneyLine(store, s, cheapest) {
  if (!s) return `<div class="line"><span class="pill">${store}</span><span class="small">yok</span></div>`;
  const disc = (typeof s.discount_percent === "number" && s.discount_percent > 0) ? `<span class="tag">-${s.discount_percent}%</span>` : "";
  let priceHtml = "";
  if (s.final_formatted) {
    const strike = (s.initial_formatted && s.initial_formatted !== s.final_formatted) ? `<span class="strike">${escapeHtml(s.initial_formatted)}</span>` : "";
    priceHtml = `${strike}<span class="price">${escapeHtml(s.final_formatted)}</span> ${disc}`;
  } else {
    priceHtml = `<span class="small">yükleniyor / yok...</span>`;
  }
  const cls = cheapest ? "green" : "";
  const link = s.url ? `<a class="btn" href="${s.url}" target="_blank" rel="noopener">Mağazaya git</a>` : `<span class="small">link yok</span>`;
  return `
    <div class="line ${cls}">
      <span class="pill">${store}</span>
      <div style="text-align:right">
        <div>${priceHtml}</div>
        <div>${link}</div>
      </div>
    </div>
  `;
}

function pickCheapest(steam, epic){
  const s = (steam && typeof steam.final_amount === "number") ? steam.final_amount : null;
  const e = (epic && typeof epic.final_amount === "number") ? epic.final_amount : null;
  if (s == null && e == null) return { steam:false, epic:false };
  if (s != null && e == null) return { steam:true, epic:false };
  if (s == null && e != null) return { steam:false, epic:true };
  if (s <= e) return { steam:true, epic:false };
  return { steam:false, epic:true };
}

function render(list){
  elGrid.innerHTML = list.map(g => {
    const cheapest = pickCheapest(g.steam, (g.epic && g.epic.status==="ok") ? g.epic : null);
    const steamBox = moneyLine("Steam", g.steam, cheapest.steam);
    const epicData = (g.epic && g.epic.status==="ok") ? {
      url: g.epic.url,
      discount_percent: (typeof g.epic.discount_percent==="number") ? g.epic.discount_percent : 0,
      original_formatted: g.epic.original_formatted,
      final_formatted: g.epic.final_formatted,
      final_amount: g.epic.final_amount
    } : null;
    const epicBox = moneyLine("Epic", epicData, cheapest.epic);

    const img = g.header_image ? `<img class="img" src="${g.header_image}" alt="">` : `<div class="img"></div>`;
    const srcTag = g.source === "topsellers" ? "En çok satılan" : "En çok oynanan";

    return `
      <div class="card">
        <div class="topline">
          <span class="tag">#${g.rank}</span>
          <span class="tag">${srcTag}</span>
        </div>
        <div class="row">
          ${img}
          <div style="flex:1">
            <div class="title">${escapeHtml(g.name)}</div>
            <div class="muted">Steam AppID: ${g.appid}</div>
          </div>
        </div>

        <div class="sec">
          ${steamBox}
          ${epicBox}
        </div>
      </div>
    `;
  }).join("");
}

async function load(){
  elMeta.textContent = "Yükleniyor...";
  elGrid.innerHTML = "";
  const cc = elCC.value;
  const res = await fetch(API + encodeURIComponent(cc), { cache: "no-store" });
  const data = await res.json();
  ALL = Array.isArray(data.games) ? data.games : [];
  elMeta.textContent = `Tamam. ${ALL.length} oyun (Steam+Epic).`;
  applyFilter();
}

function applyFilter(){
  const q = (elQ.value || "").trim().toLowerCase();
  const list = !q ? ALL : ALL.filter(x => (x.name||"").toLowerCase().includes(q));
  render(list);
  elMeta.textContent = `Tamam. ${list.length} oyun (Steam+Epic).`;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

elQ.addEventListener("input", () => applyFilter());
elCC.addEventListener("change", () => load());

load();
</script>
</body>
</html>
