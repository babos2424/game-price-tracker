<!doctype html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Oyun Fiyat Takip</title>
<style>
body{margin:0;font-family:Arial;background:#0b1222;color:#eaf0ff}
.wrap{max-width:1100px;margin:0 auto;padding:22px}
h1{margin:0 0 6px}
.top{display:flex;gap:12px;align-items:center;margin:15px 0}
input{flex:1;padding:10px;border-radius:10px;border:1px solid #1d2a4a;background:#0c1631;color:white}
.status{color:#8aa0c5}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.card{background:#0f1a33;border:1px solid #1d2a4a;border-radius:14px;padding:14px}
.title{font-weight:700;margin-bottom:8px}
.old{text-decoration:line-through;color:#8aa0c5;margin-right:8px}
.btn{display:block;margin-top:10px;text-align:center;text-decoration:none;color:white;border:1px solid #1d2a4a;padding:8px;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
<h1>Oyun Fiyat Takip</h1>

<div class="top">
<input id="search" placeholder="Oyun ara...">
<div class="status" id="status">Yükleniyor...</div>
</div>

<div class="grid" id="grid"></div>
</div>

<script>
const API="https://steam-price-api.celikelbatuhan02.workers.dev";
const grid=document.getElementById("grid");
const statusEl=document.getElementById("status");
const search=document.getElementById("search");

let all=[];
let page=0;
let loading=false;

function money(v,c){return Number(v).toFixed(2)+" "+c;}

function render(){
  const q=search.value.toLowerCase().trim();
  const list=q?all.filter(x=>x.name.toLowerCase().includes(q)):all;

  // indirimli üste
  list.sort((a,b)=>b.steam.discount-a.steam.discount);

  grid.innerHTML="";
  list.forEach(g=>{
    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <div class="title">${g.name}</div>
      <div>
        ${g.steam.discount>0?
          `<span class="old">${money(g.steam.initial,g.steam.currency)}</span>`:""}
        ${money(g.steam.final,g.steam.currency)}
      </div>
      <a class="btn" target="_blank"
        href="https://store.steampowered.com/app/${g.appid}">
        Steam'e Git
      </a>
    `;
    grid.appendChild(card);
  });

  statusEl.textContent="Toplam "+all.length+" oyun";
}

async function loadMore(){
  if(loading) return;
  loading=true;

  statusEl.textContent="Yükleniyor...";
  const listRes=await fetch(`${API}/steam/list?start=${page*50}`);
  const listJson=await listRes.json();
  const ids=listJson.appids||[];

  for(const id of ids){
    const r=await fetch(`${API}/steam/price?appid=${id}`);
    const j=await r.json().catch(()=>null);
    if(!j||!j.ok) continue;

    all.push(j);
  }

  page++;
  loading=false;
  render();
}

// sonsuz scroll
window.addEventListener("scroll",()=>{
  if(window.innerHeight+window.scrollY>=document.body.offsetHeight-200){
    loadMore();
  }
});

search.addEventListener("input",render);

loadMore();
</script>
</body>
</html>
