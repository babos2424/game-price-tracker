<script>
/** =========================
 *  1) SABİT STEAM KURU
 *  =========================
 *  Bunu bir kere belirle, sonra kur değişse bile fiyatların değişmez.
 *  İstersen buna "Steam sabit kuru" diyelim.
 */
const STEAM_FIXED_USD_TRY = 35.00; // <- burayı istediğin sabit kur yap

/** TL format */
function fmtTRY(amount) {
  return new Intl.NumberFormat("tr-TR", { style: "currency", currency: "TRY" }).format(amount);
}

/** "$52.49 USD" gibi stringlerden sayı çıkarır */
function parseUsdText(steamText) {
  if (!steamText) return null;
  const s = String(steamText).replace(",", ".");
  const m = s.match(/(\d+(\.\d+)?)/);
  return m ? Number(m[1]) : null;
}

/** USD -> TL (sabit kurla) */
function usdToTryFixed(usd) {
  if (usd == null || Number.isNaN(usd)) return null;
  return usd * STEAM_FIXED_USD_TRY;
}

/** Epic minor unit (104900) -> TL */
function epicMinorToTry(minor, decimals = 2) {
  if (minor == null) return null;
  return Number(minor) / Math.pow(10, decimals);
}

/** Steam fiyat render:
 * - steamObj şu formatlardan birini destekler:
 *   A) { finalText: "$52.49 USD", originalText: "$59.99 USD" }  (indirim varsa)
 *   B) { finalText: "$52.49 USD" } (indirim yoksa)
 *
 * Not: Eğer elinde sadece tek steamText varsa, indirim/orijinal ayrımı mümkün değil.
 * Bu kod iki durumu da kaldırıyor.
 */
function renderSteamPriceHTML(steamObjOrText) {
  let finalUsd = null, originalUsd = null;

  if (typeof steamObjOrText === "string") {
    finalUsd = parseUsdText(steamObjOrText);
  } else if (steamObjOrText && typeof steamObjOrText === "object") {
    finalUsd = parseUsdText(steamObjOrText.finalText);
    originalUsd = parseUsdText(steamObjOrText.originalText);
  }

  const finalTry = usdToTryFixed(finalUsd);
  const originalTry = usdToTryFixed(originalUsd);

  if (!finalTry) return `<span class="muted">Yok</span>`;

  // indirim varsa: eski üstü çizili + yeni
  if (originalTry && originalTry > finalTry) {
    return `
      <div class="priceRow">
        <del class="old">${fmtTRY(originalTry)}</del>
        <span class="new">${fmtTRY(finalTry)}</span>
      </div>
    `;
  }

  // indirim yoksa: tek fiyat
  return `<span class="new">${fmtTRY(finalTry)}</span>`;
}

/** Epic render: Worker zaten fmtDiscount/fmtOriginal veriyor ama biz TL olarak yazıyoruz */
function renderEpicPriceHTML(epicData) {
  if (!epicData?.ok) return `<span class="muted">Bulunamadı</span>`;

  const tp = epicData.epic?.totalPrice;
  if (!tp) return `<span class="muted">Bulunamadı</span>`;

  // Epic'te original/discount minor units var
  const dec = tp.decimals ?? 2;
  const original = epicMinorToTry(tp.originalPrice, dec);
  const discount = epicMinorToTry(tp.discountPrice, dec);

  if (discount == null) return `<span class="muted">Bulunamadı</span>`;

  if (original != null && original > discount) {
    return `
      <div class="priceRow">
        <del class="old">${fmtTRY(original)}</del>
        <span class="new">${fmtTRY(discount)}</span>
      </div>
    `;
  }

  return `<span class="new">${fmtTRY(discount)}</span>`;
}

/** CSS (sayfanda style varsa oraya da koyabilirsin) */
(function injectPriceStyles(){
  const css = `
    .priceRow{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .old{opacity:.65}
    .new{font-weight:800}
    .muted{opacity:.7}
  `;
  const s = document.createElement("style");
  s.textContent = css;
  document.head.appendChild(s);
})();

/** =========================
 *  2) EPIC FİYAT ÇEK
 *  ========================= */
async function fetchEpic(slug) {
  const res = await fetch(`https://steam-price-api.celikelbatuhan02.workers.dev/epic?slug=${encodeURIComponent(slug)}&country=TR&locale=tr`);
  return await res.json();
}

/** =========================
 *  3) STEAM FİYAT ÇEK
 *  =========================
 *  Burayı SENİN mevcut Steam fetch fonksiyonuna bağlayacağız.
 *  Şu an sende Steam tarafı ekranda "$52.49 USD" gibi görünüyor.
 *
 *  Eğer Steam’den sadece 1 fiyat metni alıyorsan:
 *    return { finalText: steamText }
 *
 *  Eğer Steam’den hem eski hem yeni geliyorsa:
 *    return { finalText: "...", originalText: "..." }
 */
async function fetchSteamForRender(appId, country="TR") {
  // !!! Burayı SENİN mevcut Steam endpoint'ine göre düzenle.
  // ÖRNEK: { finalText: "$52.49 USD", originalText:"$59.99 USD" } döndürecek şekilde.
  const r = await fetch(`https://steam-price-api.celikelbatuhan02.workers.dev/steam?appid=${appId}&cc=${country}`);
  const d = await r.json();

  // AŞAĞIDAKİ MAPPING'i senin JSON'una göre ayarla:
  // Eğer sadece tek fiyat geliyorsa:
  if (d?.steam_price_text) {
    return { finalText: d.steam_price_text };
  }

  // Eğer indirimli + orijinal ayrı geliyorsa:
  if (d?.final_text && d?.original_text) {
    return { finalText: d.final_text, originalText: d.original_text };
  }

  // Hiçbiri yoksa boş dön
  return null;
}

/** =========================
 *  4) Kart içine basma örneği
 *  =========================
 *  Bu fonksiyonu kart oluştururken çağır:
 *    applyPricesToCard(game, steamEl, epicEl)
 */
async function applyPricesToCard(game, steamPriceEl, epicPriceEl) {
  // Steam
  steamPriceEl.innerHTML = `<span class="muted">Yükleniyor...</span>`;
  const steamObj = await fetchSteamForRender(game.steamAppId, "TR");
  steamPriceEl.innerHTML = steamObj ? renderSteamPriceHTML(steamObj) : `<span class="muted">Yok</span>`;

  // Epic
  epicPriceEl.innerHTML = `<span class="muted">Yükleniyor...</span>`;
  const epicData = await fetchEpic(game.epicSlug);
  epicPriceEl.innerHTML = renderEpicPriceHTML(epicData);
}
</script>
