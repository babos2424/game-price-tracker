<!doctype html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Oyun Fiyat Takip (TR) - Test</title>
<style>
body{margin:0;font-family:Arial;background:#0b1222;color:#eaf0ff}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
h1{margin:0 0 15px}
.status{color:#8aa0c5;margin-bottom:14px;white-space:pre-wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.card{background:#111c3a;border:1px solid #1d2a4a;border-radius:14px;padding:14px}
.title{font-weight:700;margin-bottom:8px}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.old{text-decoration:line-through;color:#8aa0c5;margin-right:6px}
.badge{background:#22c55e;padding:3px 6px;border-radius:6px;font-size:12px;margin-left:6px}
.pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #1d2a4a;color:#cbd5e1}
.green{border-color:#22c55e}
.btn{display:block;margin-top:10px;text-align:center;text-decoration:none;color:#fff;border:1px solid #1d2a4a;padding:8px;border-radius:10px}
.small{font-size:12px;color:#8aa0c5}
</style>
</head>
<body>
<div class="wrap">
  <h1>Oyun Fiyat Takip (TR) – Test</h1>
  <div class="status" id="status">Yükleniyor...</div>
  <div class="grid" id="grid"></div>
</div>

<script>
const API = "https://steam-price-api.celikelbatuhan02.workers.dev";
const statusEl = document.getElementById("status");
const grid = document.getElementById("grid");

// ✅ SADECE 2 OYUN
const GAMES = [
  { title:"Red Dead Redemption 2", steam_appid: 1174180, epic_query:"Red Dead Redemption 2" },
  { title:"Grand Theft Auto V Enhanced", steam_appid: 3240220, epic_query:"Grand Theft Auto V" }
];

// Basit CORS proxy (epic HTML/JSON çekmek için)
function proxy(url){
  // r.jina.ai çoğu sitede CORS ile text döndürür
  return "https://r.jina.ai/http://" + url.replace(/^https?:\/\//,"");
}

function money(v,c){
  const n=Number(v);
  if(!Number.isFinite(n)) return "— "+(c||"TRY");
  return n.toFixed(2)+" "+(c||"TRY");
}

function bestStoreClass(steamFinal, epicFinal){
  const s=Number(steamFinal), e=Number(epicFinal);
  if(!Number.isFinite(s) && !Number.isFinite(e)) return {steam:false, epic:false};
  if(!Number.isFinite(e)) return {steam:true, epic:false};
  if(!Number.isFinite(s)) return {steam:false, epic:true};
  if(s<=e) return {steam:true, epic:false};
  return {steam:false, epic:true};
}

function cardSkeleton(g){
  const div=document.createElement("div");
  div.className="card";
  div.innerHTML=`
    <div class="title">${g.title}</div>

    <div class="row" data-steam="row">
      <span class="pill">Steam</span>
      <span class="small">Yükleniyor...</span>
    </div>

    <div class="row small" data-epic="row">
      Epic: <span class="pill">Yükleniyor...</span>
    </div>

    <a class="btn" target="_blank" data-steam-btn>Steam'e Git</a>
    <a class="btn" target="_blank" data-epic-btn style="display:none">Epic'e Git</a>
  `;
  return div;
}

async function getSteam(appid){
  const r = await fetch(`${API}/steam/price?appid=${appid}`, {cache:"no-store"});
  return await r.json().catch(()=>null);
}

// ✅ Epic otomatik: önce arama sayfasından ilk /p/ slug bul → ürün sayfasından totalPrice çek
async function getEpicAuto(queryName){
  // 1) Epic browse search HTML
  const searchUrl = `https://store.epicgames.com/en-US/browse?q=${encodeURIComponent(queryName)}&sortBy=relevancy&sortDir=DESC`;
  const sTxt = await fetch(proxy(searchUrl), {cache:"no-store"}).then(r=>r.text()).catch(()=>null);
  if(!sTxt) return {ok:false, error:"search_fetch_failed"};

  // Arama HTML içinde /p/slug yakala (ilk bulunan)
  const mSlug = sTxt.match(/\/p\/([a-z0-9-]+)/i);
  if(!mSlug) return {ok:false, error:"no_slug"};

  const slug = mSlug[1];
  const productUrl = `https://store.epicgames.com/p/${slug}`;

  // 2) Ürün sayfası HTML
  const pTxt = await fetch(proxy(productUrl), {cache:"no-store"}).then(r=>r.text()).catch(()=>null);
  if(!pTxt) return {ok:false, error:"product_fetch_failed", slug};

  // 3) totalPrice JSON çek
  const mPrice = pTxt.match(/"totalPrice":\s*({[^}]*})/);
  if(!mPrice) return {ok:false, error:"price_not_found", slug};

  let tp;
  try{ tp = JSON.parse(mPrice[1]); }catch{ return {ok:false, error:"price_parse_failed", slug}; }

  const final = Number(tp.discountPrice)/100;
  const initial = Number(tp.originalPrice)/100;

  let discount = 0;
  if(initial > 0 && Number.isFinite(final) && Number.isFinite(initial)){
    discount = Math.round((1 - final/initial) * 100);
    if(discount < 0) discount = 0;
    if(discount > 99) discount = 99;
  }

  return {
    ok:true,
    epic:{
      currency: tp.currencyCode || "TRY",
      final, initial, discount
    },
    epic_url: productUrl,
    slug
  };
}

async function boot(){
  statusEl.textContent = "2 oyun test ediliyor: RDR2 + GTA V Enhanced";

  grid.innerHTML = "";
  const cards = new Map();

  for(const g of GAMES){
    const c = cardSkeleton(g);
    grid.appendChild(c);
    cards.set(g.steam_appid, c);

    // Steam link
    c.querySelector("[data-steam-btn]").href = `https://store.steampowered.com/app/${g.steam_appid}`;
  }

  // Paralel çek
  await Promise.all(GAMES.map(async (g)=>{
    const c = cards.get(g.steam_appid);

    const [steam, epic] = await Promise.all([
      getSteam(g.steam_appid),
      getEpicAuto(g.epic_query)
    ]);

    // Steam render
    const steamRow = c.querySelector('[data-steam="row"]');
    if(steam?.ok){
      const disc = Number(steam?.steam?.discount||0);
      const badge = disc>0?`<span class="badge">-${disc}%</span>`:"";
      const old = disc>0?`<span class="old">${money(steam.steam.initial, steam.steam.currency)}</span>`:"";
      steamRow.innerHTML = `<span class="pill">Steam</span> ${old} <span>${money(steam.steam.final, steam.steam.currency)}</span> ${badge}`;
    }else{
      steamRow.innerHTML = `<span class="pill">Steam</span> <span class="small">Bulunamadı</span>`;
    }

    // Epic render
    const epicRow = c.querySelector('[data-epic="row"]');
    const epicBtn = c.querySelector('[data-epic-btn]');
    if(epic?.ok){
      const disc = Number(epic?.epic?.discount||0);
      const badge = disc>0?`<span class="badge">-${disc}%</span>`:"";
      const old = disc>0?`<span class="old">${money(epic.epic.initial, epic.epic.currency)}</span>`:"";
      epicRow.innerHTML = `Epic: <span class="pill">Epic</span> ${old} <span>${money(epic.epic.final, epic.epic.currency)}</span> ${badge}`;
      epicBtn.href = epic.epic_url;
      epicBtn.style.display = "block";
    }else{
      epicRow.innerHTML = `Epic: <span class="pill">Bulunamadı</span>`;
    }

    // En ucuzu yeşil
    const best = bestStoreClass(
      Number(steam?.steam?.final),
      Number(epic?.epic?.final)
    );
    const steamPill = c.querySelector('[data-steam="row"] .pill');
    const epicPill = c.querySelector('[data-epic="row"] .pill');
    if(steamPill && best.steam) steamPill.classList.add("green");
    if(epicPill && best.epic) epicPill.classList.add("green");
  }));

  statusEl.textContent = "Bitti ✅ (RDR2 + GTA V Enhanced)";
}

boot();
</script>
</body>
</html>
