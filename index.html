<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oyun Fiyat Takip</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0e1a33; --panel2:#0c1730;
      --text:#e5e7eb; --muted:#94a3b8; --border:#223255;
      --green:#22c55e; --red:#ef4444; --yellow:#f59e0b;
      --btn:#12234a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#070b16, #0b1020);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:14px}
    .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,input,button{
      border:1px solid var(--border); background:rgba(17,28,51,.7); color:var(--text);
      padding:10px 12px;border-radius:10px; outline:none;
    }
    input{min-width:240px}
    button{background:var(--btn); cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .hint{color:var(--muted); font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:14px}
    .card{
      background:rgba(14,26,51,.7);
      border:1px solid rgba(34,50,85,.9);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .title{font-size:20px;font-weight:800;margin:0 0 8px}
    .row{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin:6px 0}
    .store{color:#cbd5e1;font-weight:700;font-size:13px}
    .price{font-size:15px}
    .muted{color:var(--muted)}
    .strike{text-decoration:line-through; opacity:.7; margin-right:8px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid rgba(255,255,255,.12)}
    .badge-sale{background:rgba(245,158,11,.12);color:#fbbf24}
    .badge-miss{background:rgba(148,163,184,.10);color:#cbd5e1}
    .btnrow{display:flex;gap:10px;margin-top:10px}
    .openbtn{
      flex:1; text-align:center; text-decoration:none;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(17,28,51,.7); color:var(--text);
      font-weight:800;
    }
    .openbtn.win{background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.55)}
    .openbtn:hover{filter:brightness(1.12)}
    .tiny{font-size:12px;color:var(--muted);margin-top:10px}
    .status{margin-top:6px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <select id="country">
          <option value="TR" selected>Türkiye</option>
          <option value="US">USA</option>
          <option value="GB">UK</option>
          <option value="DE">Germany</option>
        </select>

        <select id="limit">
          <option value="50">50 oyun</option>
          <option value="100">100 oyun</option>
          <option value="150">150 oyun</option>
          <option value="200" selected>200 oyun</option>
        </select>

        <input id="q" placeholder="Oyun ara..." />
        <button id="load">Yükle</button>
      </div>

      <div class="hint pill" id="meta">Hazır.</div>
    </div>

    <div class="status" id="status"></div>
    <div class="grid" id="grid"></div>
    <div class="tiny" id="foot"></div>
  </div>

<script>
  // ✅ BURAYI KENDİ WORKER'ININ URL'İYLE DEĞİŞTİR
  const API_BASE = "https://oyun-api123.workers.dev";

  const elGrid = document.getElementById("grid");
  const elStatus = document.getElementById("status");
  const elMeta = document.getElementById("meta");
  const elFoot = document.getElementById("foot");

  const elCountry = document.getElementById("country");
  const elLimit = document.getElementById("limit");
  const elQ = document.getElementById("q");
  const elLoad = document.getElementById("load");

  let baseGames = [];   // {appid,name}
  let priced = [];      // merged {appid,name,steam,epic}

  elLoad.addEventListener("click", () => loadAll());
  elQ.addEventListener("input", () => render());

  async function loadAll() {
    elStatus.textContent = "Oyun listesi alınıyor...";
    elGrid.innerHTML = "";
    priced = [];
    baseGames = [];

    const limit = Number(elLimit.value || 200);
    const cc = (elCountry.value || "TR").toLowerCase();
    const country = (elCountry.value || "TR").toUpperCase();

    // 1) games
    const g = await fetch(`${API_BASE}/api/games?limit=${limit}&cc=${cc}`).then(r => r.json());
    baseGames = (g.games || []).slice(0, limit);

    elStatus.textContent = `Fiyatlar alınıyor... (Steam + Epic)`;
    elMeta.textContent = `${baseGames.length} oyun listelendi`;

    // 2) prices
    const p = await fetch(`${API_BASE}/api/prices?cc=${cc}&country=${country}&currency=TRY`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ games: baseGames, limit })
    }).then(r => r.json());

    const items = Array.isArray(p.items) ? p.items : [];

    // Bedava oyunları çıkar (Steam free veya final 0)
    priced = items.filter(it => {
      const s = it.steam;
      if (!s || !s.available) return true; // steam yoksa epic'e bakabilir
      if (s.is_free) return false;
      if (Number(s.final_try) === 0) return false;
      return true;
    }).slice(0, limit);

    elStatus.textContent = `Steam + Epic fiyatları yüklendi.`;
    elFoot.textContent = `Kur: 1 USD ≈ ${p.usd_try?.toFixed?.(4) ?? "?"} TRY (otomatik)`;
    render();
  }

  function render() {
    const q = (elQ.value || "").trim().toLowerCase();

    let list = priced;
    if (q) {
      list = list.filter(x => (x.name || "").toLowerCase().includes(q));
    }

    // En ucuz üste (final fiyat min)
    list = list.slice().sort((a,b) => cheapest(a) - cheapest(b));

    elGrid.innerHTML = list.map(cardHtml).join("");
  }

  function cheapest(item) {
    const s = item.steam?.available ? Number(item.steam.final_try) : Infinity;
    // Epic TRY gelmezse bile çoğu TR'de TRY gelir; gelmezse gene gösteririz ama karşılaştırma TRY olmadığı için Infinity say.
    const e = item.epic?.available && item.epic.currency === "TRY" ? Number(item.epic.final) : Infinity;
    return Math.min(s, e);
  }

  function cardHtml(item) {
    const name = esc(item.name || "Oyun");

    const steam = item.steam;
    const epic = item.epic;

    const steamPrice = formatStorePriceSteam(steam);
    const epicPrice = formatStorePriceEpic(epic);

    const best = bestStore(item);

    const steamBtnClass = best === "steam" ? "openbtn win" : "openbtn";
    const epicBtnClass  = best === "epic"  ? "openbtn win" : "openbtn";

    const steamUrl = `https://store.steampowered.com/app/${item.appid}/`;
    const epicUrl = epic?.slug ? `https://store.epicgames.com/p/${epic.slug}` : `https://store.epicgames.com/en-US/browse?q=${encodeURIComponent(item.name || "")}`;

    return `
      <div class="card">
        <div class="title">${name}</div>

        <div class="row">
          <div class="store">Steam</div>
          <div class="price">${steamPrice}</div>
        </div>

        <div class="row">
          <div class="store">Epic</div>
          <div class="price">${epicPrice}</div>
        </div>

        <div class="btnrow">
          <a class="${steamBtnClass}" href="${steamUrl}" target="_blank" rel="noopener">Steam'de Aç</a>
          <a class="${epicBtnClass}" href="${epicUrl}" target="_blank" rel="noopener">Epic'de Aç</a>
        </div>

        <div class="tiny">Steam AppID: ${item.appid}</div>
      </div>
    `;
  }

  function bestStore(item) {
    const sOk = item.steam?.available && !item.steam.is_free && Number(item.steam.final_try) > 0;
    const eOk = item.epic?.available && item.epic.currency === "TRY" && Number(item.epic.final) > 0;

    const s = sOk ? Number(item.steam.final_try) : Infinity;
    const e = eOk ? Number(item.epic.final) : Infinity;

    if (s === Infinity && e === Infinity) return null;
    return s <= e ? "steam" : "epic";
  }

  function formatStorePriceSteam(s) {
    if (!s || !s.available || s.final_try == null) return `<span class="badge badge-miss">Yok</span>`;

    // indirim varsa: initial üstü çizili + badge
    const hasDiscount = (s.discount_percent || 0) > 0 && s.initial_try > s.final_try;

    if (hasDiscount) {
      return `
        <span class="strike">${moneyTRY(s.initial_try)}</span>
        <b>${moneyTRY(s.final_try)}</b>
        <span class="badge badge-sale">%${s.discount_percent} indirim</span>
      `;
    }
    return `<b>${moneyTRY(s.final_try)}</b>`;
  }

  function formatStorePriceEpic(e) {
    if (!e || !e.available) return `<span class="badge badge-miss">Bulunamadı</span>`;

    const cur = e.currency || "TRY";
    const hasDiscount = (e.discount_percent || 0) > 0 && e.original > e.final;

    // TRY değilse gene gösterelim ama kıyaslamada kullanmıyoruz
    const fmt = (n) => cur === "TRY" ? moneyTRY(n) : `${Number(n).toFixed(2)} ${esc(cur)}`;

    if (hasDiscount) {
      return `
        <span class="strike">${fmt(e.original)}</span>
        <b>${fmt(e.final)}</b>
        <span class="badge badge-sale">%${e.discount_percent} indirim</span>
      `;
    }
    return `<b>${fmt(e.final)}</b>`;
  }

  function moneyTRY(n) {
    return new Intl.NumberFormat("tr-TR", { style: "currency", currency: "TRY" }).format(Number(n) || 0);
  }

  function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
