<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oyun Fiyat Takip</title>

<style>
  body{background:#111;color:#fff;font-family:Arial;text-align:center;padding:40px}
  .wrap{max-width:1100px;margin:0 auto}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:22px}
  .card{background:#1c1c1c;padding:18px;border-radius:14px}
  .name{margin:0 0 8px;font-size:18px}
  .price{font-size:20px;font-weight:700;margin:8px 0}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#222;margin:6px 0;font-size:13px}
  .cheap{outline:2px solid #22c55e}
  button{margin-top:10px;padding:8px 12px;border:none;border-radius:10px;cursor:pointer}
</style>
</head>

<body>
<div class="wrap">
  <h1>Oyun Fiyat Takip</h1>
  <div id="game-list" class="grid"></div>
</div>

<script>
const API = "https://steam-price-api.celikelbatuhan02.workers.dev";
const LIMIT = 500;   // ✅ 500
const BATCH = 20;

function priceToNumber(text){
  if(!text) return null;
  const s = String(text).replace(/\s/g,"");
  const only = s.replace(/[^0-9,\.]/g,"");
  const normalized = only.includes(",") && !only.includes(".")
    ? only.replace(",", ".")
    : only.replace(/,/g,"");
  const n = Number(normalized);
  return Number.isFinite(n) ? n : null;
}

async function loadTopGames(){
  const container = document.getElementById("game-list");
  container.innerHTML = "";

  // ✅ Top sellers (free filtreli geliyor)
  const topRes = await fetch(`${API}/top?limit=${LIMIT}`, { cache: "no-store" });
  const topData = await topRes.json();
  const games = topData?.games ?? [];

  const all = [];

  for (let i=0;i<games.length;i+=BATCH){
    const chunk = games.slice(i, i+BATCH);
    const appids = chunk.map(x => x.steam_appid).join(",");

    const r = await fetch(`${API}/steam-prices?appids=${appids}`, { cache: "no-store" });
    const d = await r.json();

    for (const g of chunk){
      const p = d?.results?.[g.steam_appid];

      const priceText = p?.steam_price ?? null;
      // ✅ fiyat yoksa hiç listeye ekleme
      if (!priceText) continue;

      all.push({
        name: g.name,
        appid: g.steam_appid,
        steam_price_text: priceText,
        steam_price_num: priceToNumber(priceText),
        discount_pct: p?.discount_pct ?? 0
      });
    }
  }

  // En ucuz üstte
  all.sort((a,b)=> (a.steam_price_num ?? 1e18) - (b.steam_price_num ?? 1e18));

  const cheapest = all[0]?.appid ?? null;

  for (const game of all){
    const card = document.createElement("div");
    card.className = "card" + (game.appid === cheapest ? " cheap" : "");

    const discountHtml = game.discount_pct > 0
      ? `<div class="badge">İndirim: %${game.discount_pct}</div>`
      : `<div class="badge">İndirim yok</div>`;

    card.innerHTML = `
      <h2 class="name">${game.name}</h2>
      ${discountHtml}
      <div class="price">${game.steam_price_text}</div>
      <a href="https://store.steampowered.com/app/${game.appid}/" target="_blank" rel="noopener">
        <button>Steam Sayfası</button>
      </a>
    `;
    container.appendChild(card);
  }
}

loadTopGames();
</script>

</body>
</html>
