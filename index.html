<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oyun Fiyat Takip</title>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0b1020;color:#e5e7eb}
    .wrap{max-width:1000px;margin:0 auto;padding:28px}
    h1{margin:0 0 10px;font-size:34px;color:#fff;text-align:center}
    .sub{margin:0 0 18px;color:#94a3b8;text-align:center}
    .bar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:18px 0}
    input,select,button{
      background:#111c33;border:1px solid #22314f;color:#e5e7eb;
      padding:10px 12px;border-radius:10px;outline:none
    }
    button{cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:18px}
    .card{background:#0f172a;border:1px solid #22314f;border-radius:14px;padding:14px}
    .title{font-size:16px;font-weight:700;margin:0 0 8px}
    .price{font-size:18px;font-weight:800;margin:0 0 10px}
    .meta{color:#94a3b8;font-size:12px;margin:0 0 12px}
    a.btn{
      display:inline-block;text-decoration:none;
      background:#22c55e;color:#052e12;font-weight:800;
      padding:10px 12px;border-radius:10px
    }
    .status{margin-top:14px;text-align:center;color:#94a3b8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Oyun Fiyat Takip</h1>
    <p class="sub">Steam en çok satılanlar (free hariç) — Worker’dan canlı çekiliyor</p>

    <div class="bar">
      <select id="cc">
        <option value="tr" selected>Türkiye (TRY)</option>
        <option value="us">USA (USD)</option>
        <option value="de">Germany (EUR)</option>
      </select>

      <select id="limit">
        <option value="100">100 oyun</option>
        <option value="150" selected>150 oyun</option>
        <option value="200">200 oyun</option>
      </select>

      <input id="q" placeholder="Ara: gta, resident, fifa..." />
      <button id="load">Yükle</button>
    </div>

    <div id="status" class="status">Hazır.</div>
    <div id="grid" class="grid"></div>
  </div>

  <script>
    const WORKER_BASE = "https://steam-price-api.celikelbatuhan02.workers.dev";

    const elGrid = document.getElementById("grid");
    const elStatus = document.getElementById("status");
    const elCC = document.getElementById("cc");
    const elLimit = document.getElementById("limit");
    const elQ = document.getElementById("q");
    const elLoad = document.getElementById("load");

    let allGames = [];

    function render(list) {
      elGrid.innerHTML = "";
      for (const g of list) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="title">${escapeHtml(g.name || "")}</div>
          <div class="price">${escapeHtml(g.price_text || "")}</div>
          <div class="meta">AppID: ${g.appid}</div>
          <a class="btn" href="${g.store_url}" target="_blank" rel="noopener">Steam’de Aç</a>
        `;
        elGrid.appendChild(div);
      }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    async function load() {
      const cc = elCC.value;
      const limit = elLimit.value;

      elStatus.textContent = "Yükleniyor...";
      elGrid.innerHTML = "";

      const url = `${WORKER_BASE}/topsellers?limit=${encodeURIComponent(limit)}&cc=${encodeURIComponent(cc)}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.ok) {
          elStatus.textContent = "Hata: " + (data.error || "Bilinmeyen");
          return;
        }

        allGames = data.games || [];
        elStatus.textContent = `Yüklendi: ${allGames.length} oyun (cc=${data.cc})`;

        applySearch();
      } catch (e) {
        elStatus.textContent = "Fetch hatası (CORS olabilir): " + e.toString();
      }
    }

    function applySearch() {
      const q = (elQ.value || "").trim().toLowerCase();
      if (!q) {
        render(allGames);
        return;
      }
      const filtered = allGames.filter(x => (x.name || "").toLowerCase().includes(q));
      render(filtered);
      elStatus.textContent = `Filtre: ${filtered.length} / ${allGames.length}`;
    }

    elLoad.addEventListener("click", load);
    elQ.addEventListener("input", applySearch);

    // sayfa açılınca otomatik yükle
    load();
  </script>
</body>
</html>
