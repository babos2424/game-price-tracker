<!doctype html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Oyun Fiyat Takip (TR)</title>
<style>
body{margin:0;font-family:Arial;background:#0b1222;color:#eaf0ff}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
h1{margin:0 0 15px}
.top{display:flex;gap:12px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
input{flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid #1d2a4a;background:#111c3a;color:#fff;outline:none}
.status{color:#8aa0c5;white-space:pre-wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.card{background:#111c3a;border:1px solid #1d2a4a;border-radius:14px;padding:14px}
.title{font-weight:700;margin-bottom:8px}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.old{text-decoration:line-through;color:#8aa0c5;margin-right:6px}
.badge{background:#22c55e;padding:3px 6px;border-radius:6px;font-size:12px;margin-left:6px}
.pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #1d2a4a;color:#cbd5e1}
.green{border-color:#22c55e}
.btn{display:block;margin-top:10px;text-align:center;text-decoration:none;color:#fff;border:1px solid #1d2a4a;padding:8px;border-radius:10px}
.moreWrap{margin:14px 0}
.moreBtn{width:100%;padding:12px;border-radius:12px;background:#0f1a37;color:#fff;border:1px solid #1d2a4a;cursor:pointer;font-weight:700}
.moreBtn:disabled{opacity:.55;cursor:not-allowed}
.small{font-size:12px;color:#8aa0c5}
</style>
</head>
<body>
<div class="wrap">
  <h1>Oyun Fiyat Takip (TR)</h1>
  <div class="top">
    <input id="search" placeholder="Oyun ara...">
    <div class="status" id="status">Yükleniyor...</div>
  </div>

  <div class="moreWrap">
    <button class="moreBtn" id="moreBtn" disabled>+ Daha Fazla Göster</button>
  </div>

  <div class="grid" id="grid"></div>
</div>

<script>
const API="https://steam-price-api.celikelbatuhan02.workers.dev";

const grid=document.getElementById("grid");
const statusEl=document.getElementById("status");
const search=document.getElementById("search");
const moreBtn=document.getElementById("moreBtn");

const isMobile = window.matchMedia("(max-width: 640px)").matches;
const FIRST_SHOW = isMobile ? 60 : 150;
const STEP_SHOW  = isMobile ? 40 : 100;

let all=[];
let shown=0;

// steam_appid -> epic_slug
let epicSlugByAppid = new Map();
let epicCache = new Map(); // appid -> epic result

function money(v,c){
  const n=Number(v);
  if(!Number.isFinite(n)) return "— "+(c||"TRY");
  return n.toFixed(2)+" "+(c||"TRY");
}

function bestStoreClass(steamFinal, epicFinal){
  const s=Number(steamFinal), e=Number(epicFinal);
  if(!Number.isFinite(s) && !Number.isFinite(e)) return {steam:false, epic:false};
  if(!Number.isFinite(e)) return {steam:true, epic:false};
  if(!Number.isFinite(s)) return {steam:false, epic:true};
  if(s<=e) return {steam:true, epic:false};
  return {steam:false, epic:true};
}

function cardEl(g){
  const div=document.createElement("div");
  div.className="card";
  div.dataset.name=(g.name||"").toLowerCase();
  div.dataset.appid=String(g.appid);

  const disc=Number(g?.steam?.discount||0);
  const badge=disc>0?`<span class="badge">-${disc}%</span>`:"";
  const old=disc>0?`<span class="old">${money(g.steam.initial,g.steam.currency)}</span>`:"";

  const epicSlug = epicSlugByAppid.get(String(g.appid)) || null;
  const epicLine = epicSlug
    ? `<div class="row small" data-epic="line">Epic: <span class="pill">Yükleniyor...</span></div>`
    : `<div class="row small">Epic: <span class="pill">Yok</span></div>`;

  div.innerHTML=`
    <div class="title">${g.name}${badge}</div>

    <div class="row" data-steam="row">
      <span class="pill">Steam</span>
      ${old}
      <span>${money(g.steam.final,g.steam.currency)}</span>
    </div>

    ${epicLine}

    <a class="btn" target="_blank" href="https://store.steampowered.com/app/${g.appid}">Steam'e Git</a>
    ${epicSlug ? `<a class="btn" target="_blank" data-epic="btn" style="display:none">Epic'e Git</a>` : ``}
  `;
  return div;
}

function render(){
  grid.innerHTML="";
  const frag=document.createDocumentFragment();
  const slice=all.slice(0, shown);
  for(const g of slice) frag.appendChild(cardEl(g));
  grid.appendChild(frag);
  applySearch();
  moreBtn.disabled = (shown >= all.length);
  runEpicLazy();
}

function applySearch(){
  const q=search.value.toLowerCase().trim();
  const cards=grid.children;
  for(let i=0;i<cards.length;i++){
    const name=cards[i].dataset.name;
    cards[i].style.display=(!q||name.includes(q))?"block":"none";
  }
}

let tmr;
search.addEventListener("input", ()=>{
  clearTimeout(tmr);
  tmr=setTimeout(applySearch,120);
});

moreBtn.addEventListener("click", ()=>{
  shown=Math.min(shown+STEP_SHOW, all.length);
  render();
});

async function loadGamesJson(){
  // games.json: [{ "steam_appid": 271590, "epic_slug":"grand-theft-auto-v" }, ...]
  try{
    const r=await fetch("/games.json",{cache:"no-store"});
    const j=await r.json().catch(()=>null);
    epicSlugByAppid = new Map();
    if(Array.isArray(j)){
      for(const it of j){
        const id = it?.steam_appid;
        const slug = it?.epic_slug;
        if(id && slug) epicSlugByAppid.set(String(id), String(slug));
      }
    }
  }catch(e){
    epicSlugByAppid = new Map();
  }
}

async function loadSteam(){
  statusEl.textContent="Steam snapshot...";
  const r=await fetch(`${API}/steam/snapshot?limit=250`, {cache:"no-store"});
  const snapHeader = r.headers.get("x-snapshot") || "";
  const j=await r.json().catch(()=>null);

  if(!j || !j.ok || !Array.isArray(j.items)){
    statusEl.textContent="Hata: Steam snapshot yok.";
    return;
  }

  all=j.items;
  shown=Math.min(FIRST_SHOW, all.length);
  moreBtn.disabled=false;

  statusEl.textContent = `Toplam ${all.length} oyun • ${snapHeader.toUpperCase()} • ${j.ts}`;
  render();
}

async function fetchEpicFor(appid, slug){
  if(epicCache.has(appid)) return epicCache.get(appid);

  try{
    const r = await fetch(`https://store.epicgames.com/p/${slug}`, {
      headers:{ "accept":"text/html" }
    });

    const html = await r.text();

    const m = html.match(/"totalPrice":\s*({[^}]*})/);
    if(!m){
      const fail = { ok:false };
      epicCache.set(appid, fail);
      return fail;
    }

    let totalPrice;
    try{
      totalPrice = JSON.parse(m[1]);
    }catch{
      const fail = { ok:false };
      epicCache.set(appid, fail);
      return fail;
    }

    const final = Number(totalPrice.discountPrice)/100;
    const initial = Number(totalPrice.originalPrice)/100;

    let discount = 0;
    if(initial > 0){
      discount = Math.round((1 - final/initial)*100);
    }

    const result = {
      ok:true,
      epic:{
        currency: totalPrice.currencyCode || "TRY",
        final,
        initial,
        discount
      },
      epic_url: `https://store.epicgames.com/p/${slug}`
    };

    epicCache.set(appid, result);
    return result;

  }catch{
    const fail = { ok:false };
    epicCache.set(appid, fail);
    return fail;
  }
}

let io;
function runEpicLazy(){
  if(!("IntersectionObserver" in window)) return;

  if(!io){
    io = new IntersectionObserver(async (entries)=>{
      for(const e of entries){
        if(!e.isIntersecting) continue;
        const card = e.target;
        io.unobserve(card);

        const appid = String(card.dataset.appid);
        const slug = epicSlugByAppid.get(appid);
        if(!slug) continue;

        const g = all.find(x=>String(x.appid)===appid);
        if(!g) continue;

        const line = card.querySelector('[data-epic="line"]');
        if(!line) continue;

        const epic = await fetchEpicFor(appid, slug);

        if(!epic || !epic.ok){
          line.innerHTML = `Epic: <span class="pill">Bulunamadı</span>`;
          return;
        }

        const ed = Number(epic?.epic?.discount||0);
        const eold = ed>0 ? `<span class="old">${money(epic.epic.initial, epic.epic.currency)}</span>` : "";

        line.innerHTML =
          `Epic: <span class="pill">Epic</span> ${eold} <span>${money(epic.epic.final, epic.epic.currency)}</span>` +
          (ed>0 ? ` <span class="badge">-${ed}%</span>` : ``);

        const btn = card.querySelector('[data-epic="btn"]');
        if(btn && epic.epic_url){
          btn.href = epic.epic_url;
          btn.style.display = "block";
        }

        const best = bestStoreClass(Number(g?.steam?.final), Number(epic?.epic?.final));
        const steamPill = card.querySelector('[data-steam="row"] .pill');
        const epicPill = line.querySelector(".pill");
        if(steamPill && best.steam) steamPill.classList.add("green");
        if(epicPill && best.epic) epicPill.classList.add("green");
      }
    }, {rootMargin:"300px"});
  }

  const cards = grid.querySelectorAll(".card");
  for(const c of cards) io.observe(c);
}

(async function boot(){
  await loadGamesJson();
  await loadSteam();
})();
</script>
</body>
</html>
