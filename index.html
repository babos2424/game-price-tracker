<!doctype html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Oyun Fiyat Takip</title>

<style>
body{margin:0;font-family:Arial;background:#0b1222;color:#eaf0ff}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
h1{margin:0 0 15px}
.top{display:flex;gap:12px;align-items:center;margin-bottom:20px}
input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid #1d2a4a;
  background:#111c3a;
  color:white;
}
.status{color:#8aa0c5}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:14px;
}
.card{
  background:#111c3a;
  border:1px solid #1d2a4a;
  border-radius:14px;
  padding:14px;
}
.title{font-weight:700;margin-bottom:8px}
.old{text-decoration:line-through;color:#8aa0c5;margin-right:8px}
.btn{
  display:block;
  margin-top:10px;
  text-align:center;
  text-decoration:none;
  color:white;
  border:1px solid #1d2a4a;
  padding:8px;
  border-radius:10px;
}
</style>
</head>

<body>
<div class="wrap">
<h1>İndirimli Steam Oyunları</h1>

<div class="top">
<input id="search" placeholder="Oyun ara...">
<div class="status" id="status">Yükleniyor...</div>
</div>

<div class="grid" id="grid"></div>
</div>

<script>
const API="https://steam-price-api.celikelbatuhan02.workers.dev";
const grid=document.getElementById("grid");
const statusEl=document.getElementById("status");
const search=document.getElementById("search");

let all=[];
let renderTimeout;

function money(v,c){ return Number(v).toFixed(2)+" "+c; }

function render(){
  const q=search.value.toLowerCase().trim();
  const list=q?all.filter(x=>x.name.toLowerCase().includes(q)):all;

  grid.innerHTML="";
  for(const g of list){
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="title">${g.name}</div>
      <div>
        <span class="old">${money(g.steam.initial,g.steam.currency)}</span>
        ${money(g.steam.final,g.steam.currency)}
      </div>
      <a class="btn" target="_blank"
        href="https://store.steampowered.com/app/${g.appid}">
        Steam'e Git
      </a>
    `;
    grid.appendChild(card);
  }

  statusEl.textContent="Toplam "+list.length+" indirimli oyun";
}

search.addEventListener("input",()=>{
  clearTimeout(renderTimeout);
  renderTimeout=setTimeout(render,150);
});

async function load(){
  statusEl.textContent="Liste alınıyor...";
  let ids=[];

  // 5 sayfa = 250 oyun
  for(let i=0;i<5;i++){
    const r=await fetch(`${API}/steam/list?start=${i*50}`);
    const j=await r.json();
    if(j.ok) ids.push(...j.appids);
  }

  statusEl.textContent="İndirimli oyunlar taranıyor...";

  // paralel hız
  const concurrency=10;
  let index=0;

  async function worker(){
    while(index<ids.length && all.length<150){
      const id=ids[index++];
      const r=await fetch(`${API}/steam/price?appid=${id}`);
      const j=await r.json().catch(()=>null);
      if(!j||!j.ok) continue;

      // DLC filtre
      if(!j.name||!j.steam) continue;

      // sadece indirimli
      if(j.steam.discount<=0) continue;

      all.push(j);
    }
  }

  await Promise.all(Array(concurrency).fill(0).map(worker));

  // indirim oranına göre sırala
  all.sort((a,b)=>b.steam.discount-a.steam.discount);

  render();
}

load();
</script>

</body>
</html>
