<script>
const API="https://steam-price-api.celikelbatuhan02.workers.dev";
const grid=document.getElementById("grid");
const statusEl=document.getElementById("status");
const search=document.getElementById("search");

let all=[];
let renderTimer;

function money(v,c){
  const n = Number(v);
  if(!Number.isFinite(n)) return "— "+c;
  return n.toFixed(2)+" "+c;
}

function addCard(g){
  const card=document.createElement("div");
  card.className="card";
  card.dataset.name=(g.name||"").toLowerCase();

  card.innerHTML=`
    <div class="title">
      ${g.name}
      <span class="badge">-${g.steam.discount}%</span>
    </div>
    <div>
      <span class="old">${money(g.steam.initial,g.steam.currency)}</span>
      ${money(g.steam.final,g.steam.currency)}
    </div>
    <a class="btn" target="_blank"
      href="https://store.steampowered.com/app/${g.appid}">
      Steam'e Git
    </a>
  `;

  grid.appendChild(card);
}

function filter(){
  const q=search.value.toLowerCase().trim();
  const cards=grid.children;

  for(let i=0;i<cards.length;i++){
    const name=cards[i].dataset.name;
    cards[i].style.display=(!q||name.includes(q))?"block":"none";
  }
}

search.addEventListener("input",()=>{
  clearTimeout(renderTimer);
  renderTimer=setTimeout(filter,120);
});

// ✅ Timeout’lu fetch (mobilde takılmayı bitirir)
async function fetchJSON(url, timeoutMs=12000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const r = await fetch(url, { signal: ctrl.signal });
    return await r.json();
  }catch(e){
    return null;
  }finally{
    clearTimeout(t);
  }
}

async function load(){
  statusEl.textContent="Liste alınıyor...";

  let ids=[];

  // 4 sayfa = 200 oyun
  for(let i=0;i<4;i++){
    const j = await fetchJSON(`${API}/steam/list?start=${i*50}`, 12000);
    if(j && j.ok && Array.isArray(j.appids)) ids.push(...j.appids);
    else {
      statusEl.textContent="Liste alınamadı (timeout).";
      return;
    }
  }

  // uniq
  ids = [...new Set(ids)];

  statusEl.textContent=`İndirimli oyunlar yükleniyor... (0/${ids.length})`;

  // ✅ Mobil için concurrency düşürdük
  const concurrency = 5;

  let index = 0;
  let done = 0;

  async function worker(){
    while(index < ids.length){
      const id = ids[index++];

      const j = await fetchJSON(`${API}/steam/price?appid=${id}`, 12000);

      done++;

      // ilerleme yazısı (mobilde kullanıcı beklerken görsün)
      if(done % 5 === 0){
        statusEl.textContent = `İndirimi olanlar toplanıyor... (${done}/${ids.length}) | Bulunan: ${all.length}`;
      }

      if(!j || !j.ok) continue;

      // sadece indirimli olanları listele (istersen kaldır)
      if((j.steam?.discount||0) <= 0) continue;

      all.push(j);

      // kartları tek tek basmak mobilde yine ağır olabiliyor:
      // 10’da bir ekrana basalım
      if(all.length % 10 === 0){
        // geçici sıralama
        all.sort((a,b)=> (b.steam.discount||0)-(a.steam.discount||0));
        grid.innerHTML="";
        all.forEach(addCard);
      }
    }
  }

  await Promise.all(Array(concurrency).fill(0).map(worker));

  // final sıralama ve render
  all.sort((a,b)=> (b.steam.discount||0)-(a.steam.discount||0));
  grid.innerHTML="";
  all.forEach(addCard);

  statusEl.textContent=`Toplam ${all.length} indirimli oyun`;
}

load();
</script>
