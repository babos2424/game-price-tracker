<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oyun Fiyat Takip</title>
  <style>
    :root{
      --bg:#0b1222;
      --card:#0f1a33;
      --muted:#8aa0c5;
      --border:#1d2a4a;
      --ok:#22c55e;
      --bad:#ef4444;
      --text:#eaf0ff;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:radial-gradient(900px 500px at 20% 0%, #132247 0%, var(--bg) 60%);color:var(--text);}
    .wrap{max-width:1000px;margin:0 auto;padding:26px;}
    h1{margin:0 0 6px;font-size:34px;letter-spacing:.2px}
    .sub{margin:0 0 16px;color:var(--muted)}
    .topbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:14px 0 18px}
    select,input{background:#0c1631;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
    input{flex:1;min-width:260px}
    .status{margin-left:auto;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(290px,1fr));gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid var(--border);border-radius:14px;padding:14px}
    .title{font-size:16px;font-weight:700;margin:0 0 10px;line-height:1.25}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0}
    .badge{font-size:12px;color:var(--muted)}
    .price{font-weight:800}
    .old{color:var(--muted);text-decoration:line-through;margin-right:8px;font-weight:700}
    .store{display:flex;gap:8px;align-items:center}
    .pill{font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:var(--muted)}
    .best{border-color:rgba(34,197,94,.65); box-shadow:0 0 0 1px rgba(34,197,94,.25) inset}
    .links{display:flex;gap:10px;margin-top:10px}
    .btn{flex:1;text-align:center;text-decoration:none;color:var(--text);border:1px solid var(--border);padding:10px 10px;border-radius:12px;background:#0c1631}
    .btn:hover{border-color:#2c3c68}
    .err{color:#ffd3d3;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);padding:10px 12px;border-radius:12px;margin:12px 0;display:none}
    .tiny{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Oyun Fiyat Takip</h1>
    <p class="sub">Steam + Epic — 200 oyun (free yok). En ucuz mağaza yeşil. İndirimde eski fiyat üstü çizili.</p>

    <div class="topbar">
      <select id="lang">
        <option value="tr">TR</option>
        <option value="en">EN</option>
      </select>

      <input id="search" placeholder="Oyun ara (isim yaz)..." />
      <div class="status" id="status">Yükleniyor…</div>
    </div>

    <div class="err" id="err"></div>
    <div class="grid" id="grid"></div>
    <div class="tiny" id="tiny"></div>
  </div>

<script>
  // === BURAYA DOKUNMA: Worker base URL ===
  const STEAM_API_BASE = "https://steam-price-api.celikelbatuhan02.workers.dev";

  const elGrid = document.getElementById("grid");
  const elStatus = document.getElementById("status");
  const elErr = document.getElementById("err");
  const elTiny = document.getElementById("tiny");
  const elSearch = document.getElementById("search");
  const elLang = document.getElementById("lang");

  let allGames = [];

  function money(v, currency){
    if (v == null) return "—";
    const n = Number(v);
    if (!Number.isFinite(n)) return "—";
    // TR’de Steam USD gösteriyor çoğu zaman. Yine de currency yazalım.
    return `${n.toFixed(2)} ${currency || ""}`.trim();
  }

  function pickBestStore(game){
    const s = game.steam?.final ?? null;
    const e = game.epic?.final ?? null;
    if (s == null && e == null) return null;
    if (s != null && e == null) return "steam";
    if (s == null && e != null) return "epic";
    return (s <= e) ? "steam" : "epic";
  }

  function render(list){
    elGrid.innerHTML = "";
    const frag = document.createDocumentFragment();

    for(const g of list){
      const best = pickBestStore(g);

      const steamDiscount = (g.steam?.discount || 0) > 0 && (g.steam?.initial || 0) > (g.steam?.final || 0);
      const epicDiscount = (g.epic?.discount || 0) > 0 && (g.epic?.initial || 0) > (g.epic?.final || 0);

      const card = document.createElement("div");
      card.className = "card";

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = g.name || ("App " + g.appid);
      card.appendChild(title);

      // Steam row
      const r1 = document.createElement("div");
      r1.className = "row";
      const left1 = document.createElement("div");
      left1.className = "store";
      left1.innerHTML = `<span class="pill ${best==="steam" ? "best":""}">Steam</span><span class="badge">(${g.steam?.currency || ""})</span>`;
      const right1 = document.createElement("div");
      right1.className = "price";
      right1.innerHTML = steamDiscount
        ? `<span class="old">${money(g.steam.initial, g.steam.currency)}</span>${money(g.steam.final, g.steam.currency)}`
        : `${money(g.steam?.final, g.steam?.currency)}`;
      r1.appendChild(left1);
      r1.appendChild(right1);
      card.appendChild(r1);

      // Epic row
      const r2 = document.createElement("div");
      r2.className = "row";
      const left2 = document.createElement("div");
      left2.className = "store";
      left2.innerHTML = `<span class="pill ${best==="epic" ? "best":""}">Epic</span><span class="badge">(${g.epic?.currency || ""})</span>`;
      const right2 = document.createElement("div");
      right2.className = "price";
      right2.innerHTML = epicDiscount
        ? `<span class="old">${money(g.epic.initial, g.epic.currency)}</span>${money(g.epic.final, g.epic.currency)}`
        : `${money(g.epic?.final, g.epic?.currency)}`;
      r2.appendChild(left2);
      r2.appendChild(right2);
      card.appendChild(r2);

      // links
      const links = document.createElement("div");
      links.className = "links";
      const a1 = document.createElement("a");
      a1.className = "btn";
      a1.target = "_blank";
      a1.rel = "noopener";
      a1.href = g.steam?.url || ("https://store.steampowered.com/app/" + g.appid);
      a1.textContent = "Steam'e Git";

      const a2 = document.createElement("a");
      a2.className = "btn";
      a2.target = "_blank";
      a2.rel = "noopener";
      a2.href = g.epic?.url || ("https://store.epicgames.com/en-US/browse?q=" + encodeURIComponent(g.name));
      a2.textContent = "Epic'e Git";

      links.appendChild(a1);
      links.appendChild(a2);
      card.appendChild(links);

      frag.appendChild(card);
    }

    elGrid.appendChild(frag);
  }

  function applyFilter(){
    const q = (elSearch.value || "").toLowerCase().trim();
    let list = allGames;

    if(q){
      list = allGames.filter(g => (g.name || "").toLowerCase().includes(q));
    }

    elStatus.textContent = `Tamam. ${list.length} oyun (Steam+Epic).`;
    render(list);
  }

  async function load(){
    elErr.style.display = "none";
    elTiny.textContent = "";
    elStatus.textContent = "Yükleniyor…";

    const l = elLang.value === "en" ? "english" : "turkish";
    const cc = elLang.value === "en" ? "us" : "tr";

    const url = `${STEAM_API_BASE}/steam/games?limit=200&cc=${encodeURIComponent(cc)}&l=${encodeURIComponent(l)}`;

    try{
      const r = await fetch(url, { cache: "no-store" });
      const j = await r.json();

      if(!r.ok || !j.ok){
        throw new Error(j?.message || j?.error || "API hata verdi");
      }

      allGames = (j.games || []);

      // ekstra garanti: free varsa çıkar
      allGames = allGames.filter(g => (g.steam?.final || 0) > 0 && (!g.epic || (g.epic.final || 0) > 0));

      elStatus.textContent = `Tamam. ${allGames.length} oyun (Steam+Epic).`;
      elTiny.textContent = `Kaynak: Steam (Top Sellers + Most Played). Epic fiyatları isimle bulunur; bazı oyunlarda Epic fiyatı boş kalabilir.`;
      applyFilter();
    }catch(e){
      elErr.style.display = "block";
      elErr.textContent = "Hata: " + (e?.message || e);
      elStatus.textContent = "Hata oluştu.";
      elGrid.innerHTML = "";
    }
  }

  elSearch.addEventListener("input", () => {
    // hafif debounce
    window.clearTimeout(window.__t);
    window.__t = window.setTimeout(applyFilter, 120);
  });

  elLang.addEventListener("change", load);

  load();
</script>
</body>
</html>
